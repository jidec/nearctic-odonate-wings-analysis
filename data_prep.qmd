---
title: "Data Prep"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(eval = FALSE)
```

Load **colorEvoHelpers**, a package containing personal helpers

```{r}

#devtools::install_github("jidec/color-evo-helpers")
library(colorEvoHelpers)
library(dplyr)

```

Perform first clustering step, which applies recolorize to all images individually

```{r}

recolorizeSegmentDir(dir="D:/GitProjects/odomatic-wings-analysis/data/segments","D:/wing-color/data/patterns",median_blur_n = 7,cluster_cutoff = 25) 

```

In Python, look at dispersion and cohesion scores to pick a number of clusters

```{python}
#!pip install git+https://github.com/jidec/bigcrittercolor.git@main
from bigcrittercolor import clusterColorsToPatterns
from bigcrittercolor.helpers import _getIDsInFolder

ids = _getIDsInFolder("D:/wing-color/data/segments")
ids = [i + "_hind" for i in ids] + [i + "_fore" for i in ids]

clusterColorsToPatterns(img_ids=ids, preclustered=True, blur_args={'type':"gaussian",'ksize':21}, equalize_args=None,
                        colorspace="rgb",
                        cluster_args={'algo':"gaussian_mixture"},
                        data_folder="D:/wing-color/data",height_resize=20)
```

Perform second clustering step

```{python eval=FALSE}

ids = _getIDsInFolder("D:/wing-color/data/segments")
ids = [i + "_hind" for i in ids] + [i + "_fore" for i in ids]

clusterColorsToPatterns(img_ids=ids, preclustered=True, blur_args={'type':"gaussian",'ksize':21}, equalize_args=None,
                        colorspace="rgb",
                        cluster_args={'algo':"gaussian_mixture",'n':3},
                        data_folder="D:/wing-color/data",height_resize=20)

```

This is based on an old all-in-one function that I will eventually split up, make modular, and convert to a targets pipeline

Prep the wing data, returning a tuple containing:

1\. individual-level data

2\. individual-level data trimmed to phy

3\. phy trimmed to data

4\. species-level data

5\. species-level data trimmed to phy

6\. species-sex level data

7\. species-sex-forehind level data

```{r}
source("R/prepOdomaticDataFromPatterns.R")
data <- prepOdomaticDataFromPatterns(wing_img_loc = "D:/wing-color/data/patterns/grouped2",
             patpca_img_loc = "D:/wing-color/data/patterns/grouped2resized",
             tc1_1 = 0.5529, tc1_2 = 0.2470)
```
